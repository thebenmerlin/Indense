// Prisma Schema for Indense
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  SITE_ENGINEER
  PURCHASE_TEAM
  DIRECTOR
}

enum IndentStatus {
  SUBMITTED
  PURCHASE_APPROVED
  DIRECTOR_APPROVED
  ORDER_PLACED
  PARTIALLY_RECEIVED
  FULLY_RECEIVED
  CLOSED
  REJECTED
}

enum NotificationType {
  INDENT_SUBMITTED
  INDENT_PURCHASE_APPROVED
  INDENT_DIRECTOR_APPROVED
  INDENT_REJECTED
  ORDER_PLACED
  ORDER_UPDATED
  MATERIAL_RECEIVED
  DAMAGE_REPORTED
  RETURN_RAISED
}

enum ReturnStatus {
  PENDING
  APPROVED
  PROCESSED
  REJECTED
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  name         String
  role         Role
  isActive     Boolean  @default(true)
  
  // Site relationship - required for SITE_ENGINEER, null for PURCHASE_TEAM and DIRECTOR
  siteId       String?
  site         Site?    @relation(fields: [siteId], references: [id])
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastLoginAt  DateTime?
  
  // Relations
  indents          Indent[]        @relation("IndentCreator")
  purchaseApprovals Indent[]       @relation("PurchaseApprover")
  directorApprovals Indent[]       @relation("DirectorApprover")
  orders           Order[]         @relation("OrderCreator")
  receipts         Receipt[]       @relation("ReceiptCreator")
  damageReports    DamageReport[]  @relation("DamageReporter")
  returns          Return[]        @relation("ReturnCreator")
  notifications    Notification[]
  auditLogs        AuditLog[]
  refreshTokens    RefreshToken[]
  
  @@index([email])
  @@index([role])
  @@index([siteId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

// ============================================================================
// SITES
// ============================================================================

model Site {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  address     String?
  city        String?
  state       String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  indents     Indent[]
  
  @@index([code])
  @@index([isActive])
}

// ============================================================================
// MATERIALS (Master Data)
// ============================================================================

model Material {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  category    String
  unit        String   // e.g., "kg", "pieces", "meters", "cubic meters"
  description String?
  isActive    Boolean  @default(true)
  
  // Extensible specifications as JSON
  // Contains available options for size, dimensions, colors, etc.
  specifications Json?  // { "sizes": ["S", "M", "L"], "colors": ["Red", "Blue"], "dimensions": [...] }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  indentItems IndentItem[]
  
  @@index([name])
  @@index([code])
  @@index([category])
}

// ============================================================================
// INDENTS (Material Requests)
// ============================================================================

model Indent {
  id              String       @id @default(uuid())
  indentNumber    String       @unique  // Auto-generated: IND-SITE-YYYYMM-XXXX
  status          IndentStatus @default(SUBMITTED)
  
  // Site relationship
  siteId          String
  site            Site         @relation(fields: [siteId], references: [id])
  
  // Creator (Site Engineer)
  createdById     String
  createdBy       User         @relation("IndentCreator", fields: [createdById], references: [id])
  
  // Purchase Team Approval
  purchaseApprovedById  String?
  purchaseApprovedBy    User?    @relation("PurchaseApprover", fields: [purchaseApprovedById], references: [id])
  purchaseApprovedAt    DateTime?
  purchaseRemarks       String?
  
  // Director Approval
  directorApprovedById  String?
  directorApprovedBy    User?    @relation("DirectorApprover", fields: [directorApprovedById], references: [id])
  directorApprovedAt    DateTime?
  directorRemarks       String?
  
  // Rejection info (if rejected at any stage)
  rejectedById    String?
  rejectedAt      DateTime?
  rejectionReason String?
  
  // Priority and notes
  priority        String    @default("NORMAL")  // LOW, NORMAL, HIGH, URGENT
  notes           String?
  requiredByDate  DateTime?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  closedAt        DateTime?
  
  // Relations
  items           IndentItem[]
  order           Order?
  notifications   Notification[]
  auditLogs       AuditLog[]
  
  @@index([indentNumber])
  @@index([status])
  @@index([siteId])
  @@index([createdById])
  @@index([createdAt])
}

model IndentItem {
  id              String   @id @default(uuid())
  
  // Indent relationship
  indentId        String
  indent          Indent   @relation(fields: [indentId], references: [id], onDelete: Cascade)
  
  // Material relationship
  materialId      String
  material        Material @relation(fields: [materialId], references: [id])
  
  // Quantities
  requestedQty    Float
  receivedQty     Float    @default(0)
  pendingQty      Float    // Calculated: requestedQty - receivedQty
  
  // Specifications selected for this item
  specifications  Json?    // { "size": "Large", "color": "Red", "dimensions": "10x10" }
  
  // Notes specific to this item
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  receiptItems    ReceiptItem[]
  damageReports   DamageReport[]
  
  @@index([indentId])
  @@index([materialId])
}

// ============================================================================
// ORDERS (After Director Approval)
// ============================================================================

model Order {
  id              String   @id @default(uuid())
  orderNumber     String   @unique  // Auto-generated: ORD-YYYYMM-XXXX
  
  // Link to indent
  indentId        String   @unique
  indent          Indent   @relation(fields: [indentId], references: [id])
  
  // Vendor information (entered after offline procurement)
  vendorName      String
  vendorContact   String?
  vendorEmail     String?
  vendorAddress   String?
  
  // Pricing (ONLY visible to Purchase Team and Director)
  totalAmount     Float?
  taxAmount       Float?
  shippingAmount  Float?
  grandTotal      Float?
  
  // Delivery information
  expectedDeliveryDate DateTime?
  actualDeliveryDate   DateTime?
  deliveryStatus       String    @default("PENDING")  // PENDING, IN_TRANSIT, DELIVERED
  
  // Order creator (Purchase Team member)
  createdById     String
  createdBy       User     @relation("OrderCreator", fields: [createdById], references: [id])
  
  // Notes
  remarks         String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  orderItems      OrderItem[]
  
  @@index([orderNumber])
  @@index([indentId])
  @@index([createdAt])
}

model OrderItem {
  id              String   @id @default(uuid())
  
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Material details (copied from indent item for reference)
  materialName    String
  materialCode    String
  specifications  Json?
  
  quantity        Float
  unitPrice       Float?   // ONLY visible to Purchase Team and Director
  totalPrice      Float?   // ONLY visible to Purchase Team and Director
  
  @@index([orderId])
}

// ============================================================================
// RECEIPTS (Material Receipt Confirmation)
// ============================================================================

model Receipt {
  id              String   @id @default(uuid())
  receiptNumber   String   @unique  // Auto-generated: RCP-SITE-YYYYMM-XXXX
  
  // Link to order/indent
  indentId        String
  
  // Receipt creator (Site Engineer)
  createdById     String
  createdBy       User     @relation("ReceiptCreator", fields: [createdById], references: [id])
  
  // Receipt details
  receivedDate    DateTime @default(now())
  deliveryNote    String?
  remarks         String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           ReceiptItem[]
  images          ReceiptImage[]
  
  @@index([receiptNumber])
  @@index([indentId])
  @@index([createdAt])
}

model ReceiptItem {
  id              String   @id @default(uuid())
  
  receiptId       String
  receipt         Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  
  indentItemId    String
  indentItem      IndentItem @relation(fields: [indentItemId], references: [id])
  
  receivedQty     Float
  isComplete      Boolean  @default(false)  // True if this completes the item
  remarks         String?
  
  @@index([receiptId])
  @@index([indentItemId])
}

model ReceiptImage {
  id              String   @id @default(uuid())
  
  receiptId       String
  receipt         Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  
  filename        String
  originalName    String
  mimeType        String
  size            Int
  path            String   // Storage path
  
  uploadedAt      DateTime @default(now())
  
  @@index([receiptId])
}

// ============================================================================
// DAMAGE REPORTS & RETURNS
// ============================================================================

model DamageReport {
  id              String   @id @default(uuid())
  
  // Link to indent item
  indentItemId    String
  indentItem      IndentItem @relation(fields: [indentItemId], references: [id])
  
  // Reporter (Site Engineer)
  reportedById    String
  reportedBy      User     @relation("DamageReporter", fields: [reportedById], references: [id])
  
  // Damage details
  damagedQty      Float
  description     String
  severity        String   @default("MODERATE")  // MINOR, MODERATE, SEVERE
  
  // Resolution
  isResolved      Boolean  @default(false)
  resolvedAt      DateTime?
  resolution      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  return          Return?
  images          DamageImage[]
  
  @@index([indentItemId])
  @@index([isResolved])
}

model DamageImage {
  id              String   @id @default(uuid())
  
  damageReportId  String
  damageReport    DamageReport @relation(fields: [damageReportId], references: [id], onDelete: Cascade)
  
  filename        String
  originalName    String
  mimeType        String
  size            Int
  path            String
  
  uploadedAt      DateTime @default(now())
  
  @@index([damageReportId])
}

model Return {
  id              String       @id @default(uuid())
  returnNumber    String       @unique  // Auto-generated: RET-SITE-YYYYMM-XXXX
  
  // Link to damage report
  damageReportId  String       @unique
  damageReport    DamageReport @relation(fields: [damageReportId], references: [id])
  
  // Return creator (Site Engineer)
  createdById     String
  createdBy       User         @relation("ReturnCreator", fields: [createdById], references: [id])
  
  status          ReturnStatus @default(PENDING)
  
  // Return details
  quantity        Float
  reason          String
  
  // Processing
  approvedById    String?
  approvedAt      DateTime?
  processedAt     DateTime?
  remarks         String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([returnNumber])
  @@index([status])
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id              String           @id @default(uuid())
  type            NotificationType
  
  // Recipient
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Content
  title           String
  message         String
  data            Json?            // Additional data for navigation
  
  // Related entity
  indentId        String?
  indent          Indent?          @relation(fields: [indentId], references: [id], onDelete: SetNull)
  
  // Status
  isRead          Boolean          @default(false)
  readAt          DateTime?
  
  createdAt       DateTime         @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id              String   @id @default(uuid())
  
  // Actor
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  // Action
  action          String   // e.g., "INDENT_CREATED", "INDENT_APPROVED", "ORDER_PLACED"
  entityType      String   // e.g., "INDENT", "ORDER", "RECEIPT"
  entityId        String
  
  // State change
  previousState   String?
  newState        String?
  
  // Additional metadata
  metadata        Json?
  
  // IP and device info
  ipAddress       String?
  userAgent       String?
  
  // Related indent for easier querying
  indentId        String?
  indent          Indent?  @relation(fields: [indentId], references: [id], onDelete: SetNull)
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([indentId])
  @@index([createdAt])
}
